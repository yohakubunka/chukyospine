<% const langLabelMap = { ja: 'JP', en: 'EN', zh: 'CN' }; %>
<% const langLabel = langLabelMap[lang] || 'JP'; %>

<div class="lang-switcher">
    <div class="lang-switcher_box" data-open="false">
        <button type="button" class="lang-switcher_toggle" aria-haspopup="listbox" aria-expanded="false">
            <div class="lang-switcher_wrap">
                <img class="lang-switcher_icon" src="./images/language.svg" alt="" aria-hidden="true" />
                <span class="lang-switcher_value"><%= langLabel %></span>
            </div>
            <img class="lang-switcher_arrow" src="./images/bottom-arrow.svg" alt="" aria-hidden="true" />
        </button>
        <div class="lang-switcher_dropdown" role="listbox" aria-label="Language">
            <a class="lang-switcher_link <%= lang === 'ja' ? 'is-active' : '' %>" data-lang="ja" href="https://chukyospine.com/" target="_blank" rel="noopener noreferrer" role="option">日本語</a>
            <a class="lang-switcher_link <%= lang === 'en' ? 'is-active' : '' %>" data-lang="en" href="./index-en.html" role="option">English</a>
            <a class="lang-switcher_link <%= lang === 'zh' ? 'is-active' : '' %>" data-lang="zh" href="./index.html" role="option">中文</a>
        </div>
    </div>
</div>
<script>
    (function() {
        const box = document.querySelector('.lang-switcher_box');
        if (!box) return;

        const toggleBtn = box.querySelector('.lang-switcher_toggle');
        const dropdown = box.querySelector('.lang-switcher_dropdown');
        const links = box.querySelectorAll('.lang-switcher_link');

        const closeDropdown = () => {
            box.classList.remove('is-open');
            toggleBtn.setAttribute('aria-expanded', 'false');
        };

        const openDropdown = () => {
            box.classList.add('is-open');
            toggleBtn.setAttribute('aria-expanded', 'true');
        };

        toggleBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            if (box.classList.contains('is-open')) {
                closeDropdown();
            } else {
                openDropdown();
            }
        });

        document.addEventListener('click', () => closeDropdown());

        dropdown.addEventListener('click', (e) => e.stopPropagation());

        links.forEach((link) => {
            link.addEventListener('click', (event) => {
                const lang = link.dataset.lang;
                if (lang === 'ja') {
                    // 日本語は外部リンクを新規タブで開く
                    return;
                }

                event.preventDefault();
                const { pathname, search, hash, origin } = window.location;
                const parts = pathname.split('/');
                if (parts.length > 0) parts.pop(); // remove current file name
                const baseDir = parts.join('/') || '/';
                const normalizedBase = baseDir.endsWith('/') ? baseDir : `${baseDir}/`;
                const targetFile = lang === 'zh' ? 'index.html' : `index-${lang}.html`;
                const nextUrl = `${origin}${normalizedBase}${targetFile}${search}${hash}`;
                window.location.href = nextUrl;
            });
        });
    })();
</script>
